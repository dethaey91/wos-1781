<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Whiteout Survival â€“ Battle Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root {
  --bg: #020617;
  --panel: rgba(15,23,42,0.92);
  --border: rgba(55,65,81,0.9);
  --border-soft: rgba(148,163,184,0.45);
  --text: #e5e7eb;
  --sub: #9ca3af;
  --accent-blue: rgba(96,165,250,0.9);
  --accent-yellow: rgba(245,158,11,0.9);
  --accent-red: rgba(248,113,113,0.9);
  --accent-green: rgba(34,197,94,0.9);
}

body {
  margin: 0;
  padding: 1.5rem;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  justify-content: center;
}

.app {
  width: 100%;
  max-width: 1250px;
  background:
    radial-gradient(circle at top left, rgba(148,163,184,0.4), transparent 55%),
    radial-gradient(circle at bottom right, rgba(56,189,248,0.25), transparent 60%),
    linear-gradient(to bottom, #020617, #020617 45%, #020617);
  border-radius: 1.5rem;
  padding: 2rem;
  border: 1px solid var(--border-soft);
  box-shadow: 0 30px 80px rgba(0,0,0,0.65);
}

h1 {
  font-size: 1.9rem;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.3rem;
}

.badge {
  font-size: 0.75rem;
  border: 1px solid var(--accent-blue);
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  background: rgba(59,130,246,0.2);
  margin-left: 0.5rem;
  text-transform: uppercase;
}

.subtitle {
  color: var(--sub);
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

/* Layout */
.columns {
  display: grid;
  grid-template-columns: 1.8fr 1.2fr;
  gap: 1.2rem;
}
@media (max-width: 900px) {
  .columns {
    grid-template-columns: 1fr;
  }
}

/* Big UTC clock â€“ box fits content */
.clock-row {
  display: flex;
  justify-content: flex-end;
}
.clock-panel {
  display: inline-flex;
  flex-direction: column;
  align-items: flex-end;
  padding: 1.1rem 1.5rem;
  border-radius: 1.2rem;
  border: 1px solid rgba(148,197,253,0.6);
  background: radial-gradient(circle at top, rgba(15,23,42,0.95), rgba(15,23,42,0.85));
  margin-bottom: 1rem;
  box-shadow: 0 18px 40px rgba(15,23,42,0.9);
}
.clock-label {
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  margin-bottom: 0.35rem;
  color: #a5b4fc;
}
.clock-time {
  font-family: ui-monospace, monospace;
  font-size: 3.4rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  color: #e5f2ff;
  text-shadow: 0 0 18px rgba(148,197,255,0.6);
}

/* Cards */
.card {
  background: var(--panel);
  border-radius: 1rem;
  border: 1px solid var(--border-soft);
  padding: 1rem;
  box-shadow: 0 18px 40px rgba(15,23,42,0.9);
}
.card-title {
  font-size: 1rem;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.08em;
  margin-bottom: 0.2rem;
}
.card-subtitle {
  font-size: 0.8rem;
  color: var(--sub);
}

/* Right column stacking */
.right-stack {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Ticker */
.ticker {
  margin: 0.6rem 0 1.3rem;
  padding: 0.7rem 1.1rem;
  border-radius: 999px;
  display: flex;
  align-items: center;
  gap: 0.7rem;
  font-size: 1rem;
  font-weight: 600;
  border: 1px solid var(--accent-blue);
  background: rgba(15,23,42,0.95);
  box-shadow: 0 14px 34px rgba(0,0,0,0.6);
}
.ticker-label {
  padding: 0.25rem 0.7rem;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: rgba(15,23,42,1);
}
.ticker--idle { border-color: var(--accent-blue); }
.ticker--warning { border-color: var(--accent-yellow); box-shadow: 0 0 20px rgba(250,204,21,0.6); }
.ticker--danger { border-color: var(--accent-red); box-shadow: 0 0 25px rgba(248,113,113,0.7); }

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 0.6rem;
  border: 1px solid var(--border);
  border-radius: 0.7rem;
  overflow: hidden;
  font-size: 0.85rem;
}
thead {
  background: rgba(15,23,42,0.98);
}
th, td {
  padding: 0.5rem 0.6rem;
}

/* Rally alignment */
.rally-table th:nth-child(1),
.rally-table td:nth-child(1),
.rally-table th:nth-child(2),
.rally-table td:nth-child(2) {
  text-align: left;
}
.rally-table th:nth-child(3),
.rally-table td:nth-child(3),
.rally-table th:nth-child(4),
.rally-table td:nth-child(4) {
  text-align: right;
}

/* Pets alignment */
.pets-table th:nth-child(1),
.pets-table td:nth-child(1) {
  text-align: left;
}
.pets-table th:nth-child(2),
.pets-table td:nth-child(2),
.pets-table th:nth-child(3),
.pets-table td:nth-child(3) {
  text-align: center;
}

/* Order bubble */
.order-badge {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 1.55rem;
  height: 1.55rem;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: rgba(15,23,42,0.8);
}

/* First tag */
.first-tag {
  font-size: 0.7rem;
  padding: 0.1rem 0.35rem;
  border-radius: 999px;
  margin-left: 0.35rem;
  background: rgba(22,163,74,0.22);
  border: 1px solid var(--accent-green);
  color: #bbf7d0;
}

/* Pet badges */
.pet-badge {
  padding: 0.15rem 0.55rem;
  border-radius: 0.8rem;
  font-size: 0.8rem;
  border: 1px solid var(--border-soft);
}
.pet-badge--active {
  background: rgba(22,163,74,0.22);
  border-color: var(--accent-green);
  color: #bbf7d0;
}
.pet-badge--soon {  /* <15m remaining */
  background: rgba(234,179,8,0.18);
  border-color: var(--accent-yellow);
  color: #facc15;
}
.pet-badge--critical { /* <5m remaining */
  background: rgba(248,113,113,0.18);
  border-color: var(--accent-red);
  color: #fecaca;
}
.pet-badge--expired { /* NEW: expired (distinct from no data) */
  background: rgba(30,64,175,0.35);
  border-color: var(--accent-red);
  color: #fecaca;
}
.pet-badge--off {
  background: rgba(15,23,42,0.8);
  color: var(--sub);
}
.pet-badge--none {
  background: rgba(15,23,42,0.8);
  color: var(--sub);
}

/* Chat block area */
.chat-block {
  margin-top: 1rem;
  padding: 0.75rem 0.85rem 0.9rem;
  border-radius: 0.95rem;
  border: 1px solid var(--border);
  background: rgba(15,23,42,0.92);
}
.chat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}
.chat-title {
  font-size: 0.95rem;
  font-weight: 600;
}
textarea {
  width: 100%;
  min-height: 120px;
  background: rgba(15,23,42,0.96);
  border: 1px solid var(--border-soft);
  border-radius: 0.7rem;
  padding: 0.7rem;
  color: var(--text);
  font-size: 0.85rem;
  resize: vertical;
}

/* Buttons â€“ restored hover animation */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  border: 1px solid var(--accent-blue);
  background: radial-gradient(circle at top left, rgba(59,130,246,0.45), rgba(15,23,42,0.98));
  color: #e5e7eb;
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
}
.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 12px 28px rgba(37,99,235,0.6);
}
.btn:active {
  transform: translateY(0);
  box-shadow: 0 6px 18px rgba(37,99,235,0.6);
}
.btn.secondary {
  border-color: var(--border-soft);
  background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
}
</style>
</head>

<body>
<div class="app">
  <h1>
    Whiteout Survival â€“ Battle Dashboard
    <span class="badge">Rallies & Pets</span>
  </h1>
  <div class="subtitle">Left: Rally sync. Right: our pets & enemy pets.</div>

  <div class="clock-row">
    <div class="clock-panel">
      <div class="clock-label">Battle Time (UTC)</div>
      <div class="clock-time" id="utcClock">--:--:--</div>
    </div>
  </div>

  <div class="ticker ticker--idle" id="ticker">
    <span class="ticker-label">Pet Alert</span>
    <span id="tickerText">Loadingâ€¦</span>
  </div>

  <div class="columns">
    <!-- LEFT: RALLY CARD -->
    <div class="card">
      <div class="card-title">Rally Timing</div>
      <div class="card-subtitle">Based on march times from Plan sheet.</div>

      <table class="rally-table">
        <thead>
          <tr>
            <th>Order</th>
            <th>Player</th>
            <th>March (s)</th>
            <th>Offset</th>
          </tr>
        </thead>
        <tbody id="rallyTableBody">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>

      <div class="chat-block">
        <div class="chat-header">
          <div class="chat-title">Alliance Chat Message</div>
          <button id="copyBtn" class="btn secondary" type="button">ðŸ“‹ Copy</button>
        </div>
        <textarea id="shareText" readonly>Loadingâ€¦</textarea>
      </div>
    </div>

    <!-- RIGHT: OUR + ENEMY PETS -->
    <div class="right-stack">
      <div class="card">
        <div class="card-title">Our Pets â€“ All Whales</div>
        <div class="card-subtitle">From Pets tab (start & end).</div>

        <table class="pets-table">
          <thead>
            <tr>
              <th>Whale</th>
              <th>Window</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="petsTableBody">
            <tr><td colspan="3">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div class="card-title">Enemy Pets â€“ Opponent Whales</div>
        <div class="card-subtitle">From EnemyPets tab. Start time only, dashboard assumes 2h duration.</div>

        <table class="pets-table">
          <thead>
            <tr>
              <th>Whale</th>
              <th>Window</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="enemyPetsTableBody">
            <tr><td colspan="3">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyxyAZJahC4ouheWWMKt0KZ7fFW3PPkeTndnu3HSyuIyFZfIakN294TeC9nANU8Y5j-/exec";

let planRows = [];
let petSchedule = [];
let enemySchedule = [];
let serverOffsetMs = 0;
let serverRefDate = null;

/* CLOCK â€“ server synced, no extra 1s offset anymore */
function updateClock() {
  const now = new Date(Date.now() + serverOffsetMs);
  document.getElementById("utcClock").textContent =
    now.toISOString().substring(11,19);
}
setInterval(updateClock, 1000);

/* Helpers */
function minutesText(min) {
  return min <= 1 ? Math.round(min*60) + "s" : Math.round(min) + "m";
}

/* Our pet status */
function petStatus(p) {
  const now = new Date(Date.now() + serverOffsetMs);
  const s = new Date(p.PetStartUTC);
  const e = new Date(p.PetEndUTC);
  if (!s || !e || isNaN(s) || isNaN(e)) return {label:"No pet", type:"none"};

  const mStart = (s - now)/60000;
  const mEnd   = (e - now)/60000;

  if (mEnd <= 0) return {label:"Expired", type:"expired"};

  if (mStart > 0) {
    return {
      label: "Starts in " + minutesText(mStart),
      type: mStart <= 5 ? "soon" : "upcoming"
    };
  }

  if (mEnd < 5)  return { label:`Active (${minutesText(mEnd)} left)`, type:"critical" };
  if (mEnd < 15) return { label:`Active (${minutesText(mEnd)} left)`, type:"soon" };

  return { label:`Active (${minutesText(mEnd)} left)`, type:"active" };
}

/* Enemy window from time-of-day + 2h duration */
function buildEnemyWindow(p) {
  if (!serverRefDate || !p.PetStartUTC) return null;
  const raw = new Date(p.PetStartUTC);
  if (isNaN(raw)) return null;

  const h = raw.getUTCHours();
  const m = raw.getUTCMinutes();
  const start = new Date(serverRefDate);
  start.setUTCHours(h, m, 0, 0);
  const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);
  return { start, end };
}

function enemyPetStatus(p) {
  const window = buildEnemyWindow(p);
  if (!window) return {label:"No data", type:"none"};

  const now = new Date(Date.now() + serverOffsetMs);
  const mStart = (window.start - now)/60000;
  const mEnd   = (window.end   - now)/60000;

  if (mEnd <= 0) return {label:"Expired", type:"expired"};

  if (mStart > 0) {
    return {
      label: "Not used yet (" + minutesText(mStart) + " to start)",
      type: mStart <= 5 ? "soon" : "upcoming"
    };
  }

  if (mEnd < 5)  return { label:`Active (${minutesText(mEnd)} left)`, type:"critical" };
  if (mEnd < 15) return { label:`Active (${minutesText(mEnd)} left)`, type:"soon" };

  return { label:`Active (${minutesText(mEnd)} left)`, type:"active" };
}

/* Render our pets */
function renderPets() {
  const tbody = document.getElementById("petsTableBody");
  tbody.innerHTML = "";

  petSchedule.forEach(p => {
    const name = p.WhaleName || p.PlayerName || "-";
    const s = p.PetStartUTC ? new Date(p.PetStartUTC).toISOString().substring(11,16) : "-";
    const e = p.PetEndUTC ? new Date(p.PetEndUTC).toISOString().substring(11,16) : "-";
    const st = petStatus(p);

    tbody.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>${s} - ${e}</td>
        <td><span class="pet-badge pet-badge--${st.type}">${st.label}</span></td>
      </tr>`;
  });
}

/* Render enemy pets */
function renderEnemyPets() {
  const tbody = document.getElementById("enemyPetsTableBody");
  tbody.innerHTML = "";

  enemySchedule.forEach(p => {
    const name = p.WhaleName || p.PlayerName || "-";
    const win  = buildEnemyWindow(p);
    let winText = "-";
    if (win) {
      const s = win.start.toISOString().substring(11,16);
      const e = win.end.toISOString().substring(11,16);
      winText = `${s} - ${e}`;
    }
    const st = enemyPetStatus(p);

    tbody.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>${winText}</td>
        <td><span class="pet-badge pet-badge--${st.type}">${st.label}</span></td>
      </tr>`;
  });
}

/* Rally table */
function renderRallies() {
  const tbody = document.getElementById("rallyTableBody");
  tbody.innerHTML = "";

  planRows.forEach((r,i) => {
    tbody.innerHTML += `
      <tr>
        <td><span class="order-badge">${r.CallOrder}</span></td>
        <td>${r.PlayerName}${i===0?'<span class="first-tag">First</span>':''}</td>
        <td>${r.MarchTimeSec}</td>
        <td>${r.OffsetVsFirstSec}s</td>
      </tr>`;
  });
}

/* Ticker (our pets only) */
function updateTicker() {
  const now = new Date(Date.now() + serverOffsetMs);
  const ticker = document.getElementById("ticker");
  const text = document.getElementById("tickerText");

  let expired=[], expiring=[], upcoming=[];

  petSchedule.forEach(p => {
    const s = new Date(p.PetStartUTC);
    const e = new Date(p.PetEndUTC);
    if (!s || !e || isNaN(s) || isNaN(e)) return;

    const mStart=(s-now)/60000;
    const mEnd=(e-now)/60000;
    const name = p.WhaleName || p.PlayerName;

    if (mEnd<=0 && mEnd>-5) expired.push(name);
    else if (mEnd>0 && mEnd<5) expiring.push(name);
    else if (mStart>0 && mStart<5) upcoming.push(name);
  });

  if (expired.length) {
    text.textContent = `${expired.join(", ")} pets EXPIRED â€“ update marches!`;
    ticker.className = "ticker ticker--danger";
  }
  else if (expiring.length) {
    text.textContent = `${expiring.join(", ")} pets <5m left`;
    ticker.className = "ticker ticker--danger";
  }
  else if (upcoming.length) {
    text.textContent = `${upcoming.join(", ")} pets activate soon`;
    ticker.className = "ticker ticker--warning";
  }
  else {
    text.textContent = "No pet changes in the next 15 minutes.";
    ticker.className = "ticker ticker--idle";
  }
}

/* Chat macro */
function generateChatText() {
  let lines = ["ATTENTION - WHALE RALLY TIMINGS", ""];

  planRows.forEach((r,i) => {
    if (i===0) lines.push(`${r.PlayerName} â€“ call first`);
    else lines.push(`${r.PlayerName} â€“ call after ${r.OffsetVsFirstSec}s`);
  });

  document.getElementById("shareText").value = lines.join("\n");
}

/* Copy button */
document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(document.getElementById("shareText").value);
};

/* Fetch data */
async function fetchData() {
  const res = await fetch(API_URL + "?t=" + Date.now());
  const data = await res.json();

  if (data.updated) {
    serverRefDate = new Date(data.updated);
    const server = serverRefDate.getTime();
    const local  = Date.now();
    serverOffsetMs = server - local;
  }

  planRows      = data.plan      || data.rows || [];
  petSchedule   = data.pets      || [];
  enemySchedule = data.enemyPets || [];

  renderRallies();
  renderPets();
  renderEnemyPets();
  updateTicker();
  generateChatText();
  updateClock();
}

/* Refresh loop */
setInterval(fetchData, 10000);
fetchData();
</script>
</body>
</html>
