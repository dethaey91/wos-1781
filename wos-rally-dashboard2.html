<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WoS Rally & Pets Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 1.5rem;
      padding: 1.75rem 1.5rem 2rem;
      box-shadow: 0 24px 70px rgba(0,0,0,0.7);
      border: 1px solid rgba(148,163,184,0.35);
    }
    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .badge {
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(56,189,248,0.1);
      border: 1px solid rgba(56,189,248,0.5);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(52,211,153,0.7);
      color: #bbf7d0;
      background: rgba(22,163,74,0.25);
    }
    .clock {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      margin: 0.6rem 0;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(96,165,250,0.9);
      background: radial-gradient(circle at top left, rgba(59,130,246,0.4), rgba(15,23,42,0.98));
      color: #e5e7eb;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 25px rgba(37,99,235,0.35);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 14px rgba(37,99,235,0.35);
    }
    .btn.secondary {
      border-color: rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
    }
    .auto-refresh-label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
    }
    .ticker {
      margin: 0.2rem 0 0.8rem;
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      background: linear-gradient(
        to right,
        rgba(15,23,42,0.95),
        rgba(56,189,248,0.18)
      );
      border: 1px solid rgba(59,130,246,0.7);
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #tickerText {
      display: inline-block;
    }

    /* LAYOUT: LEFT = RALLIES, RIGHT = PETS */
    .columns {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.6fr);
      gap: 1rem;
      align-items: start;
    }
    @media (max-width: 900px) {
      .columns {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: 1rem;
      border: 1px solid rgba(75,85,99,0.9);
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      padding: 0.9rem 0.9rem 0.8rem;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      gap: 0.5rem;
    }
    .card-title {
      font-size: 0.95rem;
      font-weight: 500;
    }
    .card-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.3rem;
      overflow: hidden;
      border-radius: 0.75rem;
      border: 1px solid rgba(55,65,81,0.9);
    }
    thead {
      background: rgba(15,23,42,0.98);
    }
    th, td {
      padding: 0.45rem 0.5rem;
      text-align: left;
    }
    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      border-bottom: 1px solid rgba(55,65,81,0.9);
    }
    tbody tr:nth-child(odd) {
      background: rgba(15,23,42,0.8);
    }
    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.6);
    }
    tbody tr:first-child {
      outline: 1px solid rgba(52,211,153,0.7);
      box-shadow: 0 0 0 1px rgba(16,185,129,0.4);
    }
    tbody tr:first-child td {
      border-bottom: 1px solid rgba(34,197,94,0.4);
    }
    .order-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      height: 1.5rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.8rem;
    }
    .first-tag {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(52,211,153,0.7);
      color: #bbf7d0;
      background: rgba(22,163,74,0.23);
      margin-left: 0.25rem;
    }

    .pet-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      white-space: nowrap;
    }
    .pet-badge--none {
      opacity: 0.7;
      color: #9ca3af;
    }
    .pet-badge--upcoming {
      border-color: rgba(59,130,246,0.8);
      background: rgba(37,99,235,0.18);
      color: #bfdbfe;
    }
    .pet-badge--active {
      border-color: rgba(34,197,94,0.8);
      background: rgba(22,163,74,0.22);
      color: #bbf7d0;
    }
    .pet-badge--soon {
      border-color: rgba(245,158,11,0.9);
      background: rgba(234,179,8,0.18);
      color: #facc15;
    }
    .pet-badge--critical {
      border-color: rgba(248,113,113,0.9);
      background: rgba(248,113,113,0.18);
      color: #fecaca;
    }
    .pet-badge--off {
      border-color: rgba(75,85,99,0.9);
      background: rgba(15,23,42,0.9);
      color: #9ca3af;
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.3rem;
      min-height: 1.2em;
    }
    .status.error { color: #fca5a5; }
    .small {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 110px;
      border-radius: 0.75rem;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      padding: 0.6rem 0.7rem;
      color: #e5e7eb;
      font-size: 0.8rem;
      resize: vertical;
      outline: none;
    }
    textarea:focus {
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>
        WoS Battle Dashboard
        <span class="badge">Rallies & Pets</span>
      </h1>
      <p class="subtitle">
        Left: rally timing & copy text. Right: full live pet overview for all whales. Keep this open during the fight.
      </p>
    </header>

    <section>
      <div class="meta">
        <span class="pill">All rallies land together</span>
        <div class="clock" id="utcClock">UTC: --:--:--</div>
      </div>

      <div class="controls">
        <button id="refreshBtn" class="btn" type="button">ðŸ”„ Refresh now</button>
        <label class="auto-refresh-label">
          <input type="checkbox" id="autoRefreshToggle" checked />
          Auto-refresh every&nbsp;
          <select id="refreshIntervalSelect">
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
        </label>
      </div>

      <div class="ticker">
        <span id="tickerText">Loading pet scheduleâ€¦</span>
      </div>

      <div class="columns">
        <!-- LEFT: RALLIES -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Rally Timing</div>
              <div class="card-subtitle">Based on march times from the Plan sheet.</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Order</th>
                <th>Player</th>
                <th>March Time (s)</th>
                <th>Offset vs First</th>
              </tr>
            </thead>
            <tbody id="rallyTableBody">
              <tr>
                <td colspan="4" style="text-align:center; padding:0.9rem 0; color:#6b7280;">
                  Loading data from Google Sheets...
                </td>
              </tr>
            </tbody>
          </table>

          <div id="status" class="status"></div>
          <div class="small" id="dataUpdated">Last sheet fetch: â€”</div>

          <div style="margin-top: 0.9rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.4rem; gap:0.5rem;">
              <div style="font-size:0.9rem; font-weight:500;">Rally plan text for chat</div>
              <button id="copyBtn" class="btn secondary" type="button">ðŸ“‹ Copy</button>
            </div>
            <textarea id="shareText" readonly>Rally plan will appear here once data is loaded.</textarea>
          </div>
        </div>

        <!-- RIGHT: PETS -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Pet Status (All Whales)</div>
              <div class="card-subtitle">Read from the Pets sheet. Color shows urgency.</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Whale</th>
                <th>Window (UTC)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="petsTableBody">
              <tr>
                <td colspan="3" style="text-align:center; padding:0.9rem 0; color:#6b7280;">
                  Waiting for pet data...
                </td>
              </tr>
            </tbody>
          </table>

          <div class="small">
            Legend: green = active, yellow = <5m left / starting soon, red = <2m left, grey = expired / no pet.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_URL = "YOUR_WEB_APP_URL_HERE"; // <-- put your Apps Script Web App URL here

    const rallyTableBody = document.getElementById("rallyTableBody");
    const petsTableBody = document.getElementById("petsTableBody");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoRefreshToggle = document.getElementById("autoRefreshToggle");
    const refreshIntervalSelect = document.getElementById("refreshIntervalSelect");
    const shareTextEl = document.getElementById("shareText");
    const copyBtn = document.getElementById("copyBtn");
    const tickerTextEl = document.getElementById("tickerText");
    const utcClockEl = document.getElementById("utcClock");
    const dataUpdatedEl = document.getElementById("dataUpdated");

    let refreshTimer = null;
    let planRows = [];
    let petSchedule = [];

    // --- CLOCK (-1s offset to match in-game UTC) ---
    function updateClock() {
      const now = new Date(Date.now() - 1000); // subtract 1 second
      const iso = now.toISOString();
      const timePart = iso.substring(11, 19); // HH:MM:SS
      utcClockEl.textContent = "UTC: " + timePart;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- HELPERS ---
    function formatOffset(offset) {
      const n = Number(offset) || 0;
      if (n === 0) return "0s (first caller)";
      return n + "s after first";
    }
    function formatMinsShort(mins) {
      if (mins <= 0.5) {
        const sec = Math.max(5, Math.round(mins * 60));
        return sec + "s";
      }
      return Math.round(mins) + "m";
    }

    function getPetStatus(record) {
      const name =
        record.WhaleName || record.PlayerName || record.Name || "-";
      const start = record.PetStartUTC ? new Date(record.PetStartUTC) : null;
      const end = record.PetEndUTC ? new Date(record.PetEndUTC) : null;

      if (!start || !end || isNaN(start.getTime()) || isNaN(end.getTime())) {
        return { label: "No pet", type: "none" };
      }

      const now = new Date();
      const msToStart = start - now;
      const msToEnd = end - now;
      const minToStart = msToStart / 60000;
      const minToEnd = msToEnd / 60000;

      if (msToEnd <= 0) {
        return { label: "Expired", type: "off" };
      }

      if (msToStart > 0) {
        const t = formatMinsShort(minToStart);
        const type = minToStart <= 5 ? "soon" : "upcoming";
        return { label: "Starts in " + t, type };
      }

      // active
      const t = formatMinsShort(minToEnd);
      let type = "active";
      if (minToEnd <= 2) type = "critical";
      else if (minToEnd <= 5) type = "soon";
      return { label: "Active (" + t + " left)", type };
    }

    // For rally table, we need pet status matched by name
    function getPetStatusForName(playerName) {
      if (!petSchedule.length || !playerName) {
        return { label: "No pet", type: "none" };
      }
      const key = String(playerName).trim().toLowerCase();
      const rec = petSchedule.find(p => {
        const n =
          (p.WhaleName || p.PlayerName || p.Name || "")
            .toString()
            .trim()
            .toLowerCase();
        return n && n === key;
      });
      if (!rec) return { label: "No pet", type: "none" };
      return getPetStatus(rec);
    }

    // --- FETCH DATA FROM SHEET ---
    async function fetchData() {
      statusEl.textContent = "Updating from sheet...";
      statusEl.classList.remove("error");

      try {
        const res = await fetch(API_URL + "?t=" + Date.now());
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        planRows = data.plan || data.rows || [];
        petSchedule = data.pets || [];

        renderRallyTable();
        renderPetsTable();
        generateShareText();
        updateTicker();

        const updated = new Date(data.updated || Date.now());
        dataUpdatedEl.textContent =
          "Last sheet fetch: " + updated.toISOString().substring(11, 19) + " UTC";

        statusEl.textContent = "Loaded " + planRows.length + " rally rows, " +
          petSchedule.length + " pet rows.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading data: " + err.message;
        statusEl.classList.add("error");
        rallyTableBody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center; padding:0.9rem 0; color:#fca5a5;">
              Failed to load data. Check the API URL or your internet connection.
            </td>
          </tr>
        `;
        petsTableBody.innerHTML = `
          <tr>
            <td colspan="3" style="text-align:center; padding:0.9rem 0; color:#fca5a5;">
              Could not load pet schedule.
            </td>
          </tr>
        `;
        tickerTextEl.textContent = "Could not load pet schedule.";
      }
    }

    // --- RALLY TABLE (LEFT) ---
    function renderRallyTable() {
      rallyTableBody.innerHTML = "";

      const rows = planRows || [];
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.style.textAlign = "center";
        td.style.padding = "0.9rem 0";
        td.style.color = "#6b7280";
        td.textContent = "No data. Check that the Plan sheet has values.";
        tr.appendChild(td);
        rallyTableBody.appendChild(tr);
        return;
      }

      rows.forEach((row, index) => {
        const tr = document.createElement("tr");

        const orderTd = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "order-badge";
        badge.textContent = row.CallOrder || (index + 1);
        orderTd.appendChild(badge);

        const playerTd = document.createElement("td");
        const name = row.PlayerName || "-";
        playerTd.textContent = name;
        if (index === 0) {
          const firstTag = document.createElement("span");
          firstTag.className = "first-tag";
          firstTag.textContent = "First caller";
          playerTd.appendChild(firstTag);
        }

        const timeTd = document.createElement("td");
        timeTd.textContent = row.MarchTimeSec || "-";

        const offsetTd = document.createElement("td");
        offsetTd.textContent = formatOffset(row.OffsetVsFirstSec);

        tr.appendChild(orderTd);
        tr.appendChild(playerTd);
        tr.appendChild(timeTd);
        tr.appendChild(offsetTd);
        rallyTableBody.appendChild(tr);
      });
    }

    // --- PET TABLE (RIGHT, ALL WHALES) ---
    function renderPetsTable() {
      petsTableBody.innerHTML = "";

      const rows = petSchedule || [];
      if (!rows.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.style.textAlign = "center";
        td.style.padding = "0.9rem 0";
        td.style.color = "#6b7280";
        td.textContent = "No pet rows found. Check the Pets sheet.";
        tr.appendChild(td);
        petsTableBody.appendChild(tr);
        return;
      }

      rows.forEach(rec => {
        const tr = document.createElement("tr");

        const name = rec.WhaleName || rec.PlayerName || rec.Name || "-";
        const nameTd = document.createElement("td");
        nameTd.textContent = name;

        const windowTd = document.createElement("td");
        const start = rec.PetStartUTC ? new Date(rec.PetStartUTC) : null;
        const end = rec.PetEndUTC ? new Date(rec.PetEndUTC) : null;
        if (start && end && !isNaN(start.getTime()) && !isNaN(end.getTime())) {
          const s = start.toISOString().substring(11, 16);
          const e = end.toISOString().substring(11, 16);
          windowTd.textContent = s + " - " + e;
        } else {
          windowTd.textContent = "-";
        }

        const statusTd = document.createElement("td");
        const petStatus = getPetStatus(rec);
        const badge = document.createElement("span");
        badge.className = "pet-badge pet-badge--" + (petStatus.type || "none");
        badge.textContent = petStatus.label;
        statusTd.appendChild(badge);

        tr.appendChild(nameTd);
        tr.appendChild(windowTd);
        tr.appendChild(statusTd);
        petsTableBody.appendChild(tr);
      });
    }

    // --- RALLY CHAT TEXT ---
    function generateShareText() {
      const rows = planRows || [];
      if (!rows.length) {
        shareTextEl.value = "Rally plan will appear here once data is loaded.";
        return;
      }

      const lines = [];
      lines.push("Whale Rally Timing");

      rows.forEach((row, index) => {
        const name = row.PlayerName || "-";
        const offsetNum = Number(row.OffsetVsFirstSec) || 0;

        if (index === 0 || offsetNum === 0) {
          lines.push(`${name} â€“ call first`);
        } else {
          lines.push(`${name} â€“ call after ${offsetNum}s`);
        }
      });

      shareTextEl.value = lines.join("\n");
    }

    // --- PET TICKER (TOP) ---
    function updateTicker() {
      if (!petSchedule.length) {
        tickerTextEl.textContent = "No pet schedule data. Check the Pets tab in the sheet.";
        return;
      }

      const now = new Date();
      const upcoming = [];
      const expiring = [];
      const expired = [];

      petSchedule.forEach(p => {
        const name = p.WhaleName || p.PlayerName || p.Name || "-";
        const start = p.PetStartUTC ? new Date(p.PetStartUTC) : null;
        const end = p.PetEndUTC ? new Date(p.PetEndUTC) : null;

        if (!name || !start || !end || isNaN(start.getTime()) || isNaN(end.getTime())) {
          return;
        }

        const msToStart = start - now;
        const msToEnd = end - now;
        const minToStart = msToStart / 60000;
        const minToEnd = msToEnd / 60000;

        if (minToStart > 0 && minToStart <= 5) {
          upcoming.push({ name, mins: minToStart });
        } else if (msToStart <= 0 && msToEnd > 0 && minToEnd <= 5) {
          expiring.push({ name, mins: minToEnd });
        } else if (msToEnd <= 0 && msToEnd >= -5 * 60000) {
          expired.push({ name, mins: -minToEnd });
        }
      });

      const msgs = [];
      const fmt = (x) => formatMinsShort(x);

      if (expiring.length) {
        expiring.slice(0, 3).forEach(e =>
          msgs.push(`${e.name} pets expire in ${fmt(e.mins)}`)
        );
      } else if (expired.length) {
        expired.slice(0, 3).forEach(e =>
          msgs.push(`${e.name} pets expired â€“ update march times!`)
        );
      } else if (upcoming.length) {
        upcoming.slice(0, 3).forEach(u =>
          msgs.push(`${u.name} pets activate in ${fmt(u.mins)}`)
        );
      }

      if (!msgs.length) {
        tickerTextEl.textContent = "No pet changes in the next 5 minutes.";
      } else {
        tickerTextEl.textContent = msgs.join(" â€¢ ");
      }
    }

    // --- COPY BUTTON ---
    async function copyShareText() {
      const text = shareTextEl.value || "";
      if (!text.trim()) return;

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          shareTextEl.select();
          document.execCommand("copy");
        }
        statusEl.textContent = "Rally plan copied to clipboard.";
        statusEl.classList.remove("error");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Could not copy text. Please select and copy manually.";
        statusEl.classList.add("error");
      }
    }

    // --- WIRES & INTERVALS ---
    refreshBtn.addEventListener("click", fetchData);
    autoRefreshToggle.addEventListener("change", () => {
      if (autoRefreshToggle.checked) {
        startAutoRefresh();
      } else {
        stopAutoRefresh();
      }
    });
    refreshIntervalSelect.addEventListener("change", () => {
      if (autoRefreshToggle.checked) startAutoRefresh();
    });
    copyBtn.addEventListener("click", copyShareText);

    function startAutoRefresh() {
      stopAutoRefresh();
      const seconds = Number(refreshIntervalSelect.value) || 10;
      refreshTimer = setInterval(fetchData, seconds * 1000);
    }
    function stopAutoRefresh() {
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
    }

    // Refresh pet statuses & ticker between sheet fetches
    setInterval(() => {
      if (petSchedule.length) {
        renderPetsTable();
        updateTicker();
      }
    }, 10000);

    // Initial load
    fetchData();
    startAutoRefresh();
  </script>
</body>
</html>
